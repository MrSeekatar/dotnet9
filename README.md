# BoxServer API Project <!-- omit in toc -->

This is the repo for the BoxServer project. It was generated by the [dotnet template](https://github.com/loyalhealth/BackendDotNetTemplate) using following command and the author will, of course, remove this boilerplate text.

```powershell
# PS syntax, change ` to \ for bash
dotnet new loyal-backend-service --ObjectName Box `
    --ServiceName BoxServer `
    --output BoxServer `
    --Messaging None `
    --Telemetry AppInsights `
    --HttpPort 44300 `
    --force --allow-scripts yes
```

- [TODO](#todo)
- [Running the API](#running-the-api)
  - [Bootstrapping the Database](#bootstrapping-the-database)
  - [Required cert.pfx](#required-certpfx)
  - [Required Environment Variables](#required-environment-variables)
  - [Endpoints](#endpoints)
  - [Using run.ps1](#using-runps1)
- [Tour of the Repo](#tour-of-the-repo)
- [Pipelines](#pipelines)
  - [PR Build \& Deploy](#pr-build--deploy)
  - [Integration \& E2E Tests](#integration--e2e-tests)
- [Adding a Private DNS Record](#adding-a-private-dns-record)
- [Master Build \& Deploy](#master-build--deploy)
  - [Creating the Pipelines](#creating-the-pipelines)
  - [Running the Pipelines](#running-the-pipelines)
- [Features of the Code](#features-of-the-code)
- [Doing a Helm Dry Run Locally](#doing-a-helm-dry-run-locally)

## TODO

This was generated with the command above. To get your service up and running locally and in Kubernetes, you will need to do the following:

1. Build and run it locally, making sure it passes all tests. See [Using Run.ps1](#using-runps1) for the easy button.
1. Make sure it builds in Docker. (Again, see [Using Run.ps1](#using-runps1))
1. Push the code into GitHub. It can be on a feature branch.
1. Create pipelines in Azure DevOps to build, test, and deploy your service. See [Creating the Pipelines](#creating-the-pipelines) below.
1. Edit this README file to remove the boilerplate text and add your own.

## Running the API

### Bootstrapping the Database

In the `./Scripts` folder are scripts for use in Perses. To use them you can use `./run.ps1 updateDb` to create the database tables, etc. You can also use `./run.ps1 bootstrapDb` to seed the database with some data. It will run against the server configured in the PERSES_* environment variables described below.

If you run against a local or clean database, you will need to do some one-time initialization by running the `src/content/Scripts/util/test-database-setup.sql` script.

### Required cert.pfx

The sample code uses `TryUseLocalSsl` from Loyal.Core which requires a cert.pfx file. By default it looks in the api project's folder, but `appsettings.Development.json` has `KESTREL:CertFileName` set to look in a folder above the repo's root so you can share it across projects.

You can reuse one from another project, or generate one with the following command:

```powershell
dotnet dev-certs https -ep $env:USERPROFILE\.aspnet\https\cert.pfx -p "password"
```

### Required Environment Variables

This app uses `IConfiguration` so these values may be in appsettings, shared.appsettings, environment variables, etc. Here is a sample `shared.appsettings.Development.json` file with the minimum values required that you can fill out and put in your "code" directory (be sure not to commit it!)

```json
{
    "SERVICE:USERNAME": "TODO",
    "SERVICE:PASSWORD": "TODO",

    "DATABASE:CLIENTCONNECTIONSTRING": "TODO",
    "DATABASE:MASTERCONNECTIONSTRING": "TODO",

    "KESTREL:USELOCALSSL": "true",
    "KESTREL:CERTFILEPASSWORD": "TODO",
    // "KESTREL:CertFileName": "cert.pfx",  // Default value, appsettings.Development.json overrides to look in the parent folder

    // Perses
    "PERSES:CLIENTCONNECTIONSTRING": "TODO",
    "PERSES:MASTERCONNECTIONSTRING": "TODO",

    // Serilog Sentry setting for Perses
    "SERILOG:WRITETO:0:ARGS:DSN": "TODO",
    "SERILOG:WRITETO:0:ARGS:ENVIRONMENT": "TODO",

    // Application Insights setting
    "SERILOG:WRITETO:0:ARGS:CONNECTIONSTRING": "TODO",
}
```

### Endpoints

These are the endpoints that are available when running this API:

| Endpoint                                   | Description                                                                                |
| ------------------------------------------ | ------------------------------------------------------------------------------------------ |
| https://localhost:44300/api/health/        | Minimal health check, auth required                                                        |
| https://localhost:44300/api/health/details | Health check with details, auth required                                                   |
| https://localhost:44300/api/v1/*           | Base Url for API calls, see the [tests](src/test/integration/ApiTest.cs) for example calls |
| https://localhost:44300/docs/index.html    | Swagger endpoint                                                                           |
| https://localhost:44300/warmup             | Returns 200 if running                                                                     |

### Using run.ps1

This helper PowerShell script has the following commands, which are wrappers around other commands with all their parameters nicely filled out for you. You can run multiple comma-separated tasks. Use tab-completion to see the options and parameters.
<!-- Get-Content ./run.ps1 | Where-Object { $_ -match "^\s+'([\w+-]+)' {" } -->
| Task            | Description                                                              |
| --------------- | ------------------------------------------------------------------------ |
| build           | Builds the project                                                       |
| testUnit        | Runs unit tests                                                          |
| testIntegration | Runs integration tests. The API must be running (see run)                |
| run             | Runs the API synchronously                                               |
| buildDocker     | Builds the docker image                                                  |
| runDocker       | Runs the API in a docker container synchronously, call buildDocker first |
| buildPerses     | Builds the Perses Docker image                                           |
| generate        | Generates the API code from the ./doc/openapi.yaml file                  |
| updateDb        | Runs Perses to update the database schema                                |
| bootstrapDb     | Runs Perses to seed the database                                         |

## Tour of the Repo

<!-- tree -P *.csproj  -I bin -I obj -P *.ps1 -P *.y* -->
```text
.
├── DevOps
│   ├── boxserver-api
│   │   ├── build.yml                               # AzDO Pipeline Yaml for Build
│   │   ├── deploy.yml                              # AzDO Pipeline Yaml for Deployment
│   │   ├── integration-test-steps.yml              # AzDO Pipeline Yaml for Integration test
│   │   ├── values.yaml                             # Helm values file for use in Loyal's Chart
│   │   └── variables                               # Variable files used in build and deploy yaml
│   │       ├── variables-common.yml
│   │       ├── variables-dev.yml
│   │       ├── variables-development.yml
│   │       ├── variables-preprod.yml
│   │       ├── variables-prod.yml
│   │       └── variables-test.yml
│   └── boxserver-models
│       └── build.yml                               # AzDO Pipeline Yaml for Building NuGet package
├── Scripts                                         # SQL Scripts
│   ├── BoxServer                                    # Perses scripts added to pipeline are artifact for deploy
│   │   └── client
│   ├── int-test-bootstrap                          # integration test bootstrap data
│   │   └── client
│   └── util                                        # helper scripts used by developers
├── doc
│   └── OAS
│       └── openapi.yaml                            # OAS file for generating controllers and models
├── run.ps1                                         # helper for running local tasks, like builds, Perses, deploys, etc.
└── src
    ├── BoxServer                                    # Core of the application
    │   ├── BoxServer.csproj
    │   ├── Interfaces
    │   └── Repositories
    ├── BoxServerApi                                 # ASP.NET API
    │   ├── BoxServerApi.csproj
    │   ├── Controllers
    │   └── Properties
    ├── BoxServerModels                              # Models, mostly generated, could be NuGet for use by other projects
    │   ├── BoxServerModels.csproj
    │   └── ModelsGenerated
    └── test                                        # XUnit tests
        ├── integration                             # integration tests run in integration test pipeline against running app
        │   └── integration.csproj
        └── unit                                    # Unit tests run in build container
            └── unit.csproj
```

## Pipelines

To support code reuse, the [build](DevOps/boxserver-api/build.yml) and [deploy](DevOps/boxserver-api/deploy.yml) pipelines are quite small and leverage templates in [this](https://github.com/loyalhealth/devops-templates) repo. It's [wiki](https://github.com/loyalhealth/devops-templates/wiki) has documentation about how they work. The build pipeline is quite complex and is described on [this](https://github.com/loyalhealth/devops-templates/wiki/Build-Pipeline-Details#scenario-diagram) wiki page. The deploy pipeline is kicked off by the build pipeline to deploy to production.

### Integration Tests

The generated code has [integration](DevOps/boxserver-api/integration-test-steps.yml) tests that will hit the deployed application using `dotnet test`. Your integration test may run Pester, like the Thingy service, or some other tool. Adjust as needed.

## Adding a Private DNS Record

If you need to expose your app outside of K8s, enable the `ingress` section in the `values.yaml` file (which is the default). Then you will also need have the infra team add a DNS record to the `loyalhealth.internal` private DNS zone.

## Features of the Code

- Logging with ILogger & Serilog configured to send to Console, Seq, and Sentry or Application Insights
- For local development, it uses `shared.appsettings.Development.json` to use a common config file (probably with secrets) for multiple projects
- SQL Log file for Dapper (from Loyal.Core)
- Standard responses to API in [RFC 7807 format](https://www.rfc-editor.org/rfc/rfc7807) (From ErrorController & program.cs)
- Loyal-standard warmup and health check endpoints
- Loyal-standard Swagger doc endpoint
- Unit test within Docker
- Integration test in pipeline standing up Redis and Sql Server
- ...

## Doing a Helm Dry Run Locally

This applies if you run Rancher, or K8s locally.

The commands below will dump out the Kubernetes manifests for review. You can snag pieces of it, like the Perses job, and run it locally.

> Since helm uses your kubectl current context, it must be valid. Use `kubectl config get-contexts` to see the current contexts and `kubectl config use-context <name>` to change it.

```bash
# switch to an appropriate context
kubectl config use-context loyal-aks-dev-sc

# change to the DevOps folder with values.yaml
cd DevOps/<foldername>

# authenticate to loyal registry
$TOKEN=$(az acr login --name loyal --expose-token --output tsv --query accessToken)
helm registry login loyal.azurecr.io --username 00000000-0000-0000-0000-000000000000 --password $TOKEN

helm install --dry-run --generate-name --values ./values.yaml oci://loyal.azurecr.io/helm/loyal-app --version 3.1.0 > $TMPDIR/manifest.yaml
```
